# Machine B（2核4G）- Nacos + Higress + 其他业务服务
# 部署路径: /opt/dango-ai-code-mother
# 使用方式: docker compose up -d

services:
  nacos:
    image: nacos/nacos-server:v3.1.1
    container_name: nacos
    environment:
      MODE: standalone
      NACOS_AUTH_ENABLE: true
      NACOS_AUTH_TOKEN: ${NACOS_AUTH_TOKEN}
      NACOS_AUTH_IDENTITY_KEY: serverIdentity
      NACOS_AUTH_IDENTITY_VALUE: ${NACOS_AUTH_IDENTITY_VALUE}
      JVM_XMS: 256m
      JVM_XMX: 512m
      JVM_XMN: 128m
    volumes:
      - ./nacos/data:/home/nacos/data
      - ./nacos/logs:/home/nacos/logs
    ports:
      - "8848:8848"
      - "8858:8080"
      - "9848:9848"
    restart: unless-stopped
    mem_limit: 768m

  higress:
    image: higress-registry.cn-hangzhou.cr.aliyuncs.com/higress/all-in-one:latest
    container_name: higress
    environment:
      HIGRESS_CONSOLE_PASSWORD: ${HIGRESS_CONSOLE_PASSWORD}
      NACOS_SERVER_URL: nacos:8848
    ports:
      - "8001:8001"
      - "8080:8080"
      - "8443:8443"
    restart: unless-stopped
    mem_limit: 512m
    depends_on:
      - nacos

  user-service:
    build:
      context: ./backend
      args:
        SERVICE_MODULE: user/user-service
        SERVICE_NAME: user-service
    image: dango-ai-code-user:latest
    environment:
      JAVA_OPTS: -Xmx256m -Xms128m
      SPRING_PROFILES_ACTIVE: prod
      NACOS_ADDR: ${NACOS_ADDR}
      NACOS_NAMESPACE: prod
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
    volumes:
      - ./logs/user-service:/app/logs/user-service
    ports:
      - "8123:8123"
      - "50051:50051"
    restart: unless-stopped
    mem_limit: 512m
    depends_on:
      - nacos

  screenshot-app:
    build:
      context: ./backend
      dockerfile: Dockerfile.screenshot
    image: dango-ai-code-screenshot:latest
    environment:
      JAVA_OPTS: -Xmx256m -Xms128m
      SPRING_PROFILES_ACTIVE: prod
      NACOS_ADDR: ${NACOS_ADDR}
      NACOS_NAMESPACE: prod
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
    volumes:
      - ./logs/screenshot-app:/app/logs/screenshot-app
    ports:
      - "8125:8125"
      - "50054:50054"
    restart: unless-stopped
    mem_limit: 512m
    depends_on:
      - nacos

  supabase-service:
    build:
      context: ./backend
      args:
        SERVICE_MODULE: supabase/supabase-service
        SERVICE_NAME: supabase-service
    image: dango-ai-code-supabase:latest
    environment:
      JAVA_OPTS: -Xmx256m -Xms128m
      SPRING_PROFILES_ACTIVE: prod
      NACOS_ADDR: ${NACOS_ADDR}
      NACOS_NAMESPACE: prod
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
    volumes:
      - ./logs/supabase-service:/app/logs/supabase-service
    ports:
      - "8126:8126"
      - "50055:50055"
    restart: unless-stopped
    mem_limit: 512m
    depends_on:
      - nacos

  frontend:
    build:
      context: ./frontend
    image: dango-ai-code-frontend:latest
    environment:
      HIGRESS_ADDR: ${HIGRESS_ADDR}
    volumes:
      - ./app-data/code_deploy:/usr/share/nginx/deploy:ro
    ports:
      - "80:80"
    restart: unless-stopped
    mem_limit: 64m

  supabase-manager:
    build:
      context: ./supabase-manager
    image: dango-ai-code-supabase-manager:latest
    ports:
      - "3000:3000"
    restart: unless-stopped
    mem_limit: 192m
